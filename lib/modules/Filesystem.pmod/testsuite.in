START_MARKER
test_do( Filesystem.System() )
test_do( Filesystem.Base() )
test_do( Filesystem.Traversion(".") )

test_do([[
  string z = String.hex2string(
    "504b03040a00000000007d868845000000000000000000000000"
    "05001c00746573742f55540900031dc98554e055ef5475780b00"
    "0104e803000004e8030000504b03040a00020000007d86884520"
    "303a3606000000060000001e001c00746573742f615f6c697474"
    "6c655f746573745f66696c652e73756666697855540900031dc9"
    "8554cb5bc65475780b000104e803000004e803000068656c6c6f"
    "0a504b01021e030a00000000007d868845000000000000000000"
    "000000050018000000000000001000fd4100000000746573742f"
    "55540500031dc9855475780b000104e803000004e8030000504b"
    "01021e030a00020000007d86884520303a360600000006000000"
    "1e0018000000000001000000b4813f000000746573742f615f6c"
    "6974746c655f746573745f66696c652e73756666697855540500"
    "031dc9855475780b000104e803000004e8030000504b05060000"
    "000002000200af0000009d0000000000");
  add_constant("Z", Filesystem.Zip(0,0,Stdio.FakeFile(z)));
]])

test_equal(Z->get_dir(), ({"test"}))
test_false(Z->cd("toast"))
test_do(Z->cd("test"))
test_equal(Z->get_dir(), ({"test"}))
test_equal(Z->cd("test")->get_dir(), ({"a_little_test_file.suffix"}))
test_eq(Z->open("test/a_little_test_file.suffix","r")->read(), "hello\n")

test_do(add_constant("Z"))

test_do([[
  string z = String.hex2string(
    "504b03040a00000000007d868845000000000000000000000000"
    "05001c00746573742f55540900031dc98554e055ef5475780b00"
    "0104e803000004e8030000504b03040a000b0000007d86884520"
    "303a3612000000060000001e001c00746573742f615f6c697474"
    "6c655f746573745f66696c652e73756666697855540900031dc9"
    "85541056ef5475780b000104e803000004e80300006d26518fdc"
    "73b9932c6b737448815b46b2ed504b070820303a361200000006"
    "000000504b01021e030a00000000007d86884500000000000000"
    "0000000000050018000000000000001000fd4100000000746573"
    "742f55540500031dc9855475780b000104e803000004e8030000"
    "504b01021e030a000b0000007d86884520303a36120000000600"
    "00001e0018000000000001000000b4813f000000746573742f61"
    "5f6c6974746c655f746573745f66696c652e7375666669785554"
    "0500031dc9855475780b000104e803000004e8030000504b0506"
    "0000000002000200af000000b90000000000");
  add_constant("Z", Filesystem.Zip(0,0,Stdio.FakeFile(z)));
]])

test_equal(Z->get_dir(), ({"test"}))
test_eval_error(Z->open("test/a_little_test_file.suffix","r")->read())
test_do(Z->set_password("password"))
test_eq(Z->open("test/a_little_test_file.suffix","r")->read(), "hello\n")

test_do(add_constant("Z"))

END_MARKER
