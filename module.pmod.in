/*
  Author: Pontus Ã–stlund <https://profiles.google.com/poppanator>
*/
//! Sass is a scripting language that is interpreted into Cascading Style
//! Sheets (CSS). This module is a glue for @tt{libsass@}.
//!
//! @seealso
//!  SASS @url{http://sass-lang.com/@}

#pike __REAL_VERSION__
#require constant(Tools@module@)

//! @ignore
inherit Tools@module@;
//! @endignore

//! SCSS compiler
//!
//! @example
//! @code
//! Tools.Sass.SCSS compiler = Tools.Sass.SCSS();
//! // Minify the output and create a source map file.
//! compiler->set_options(([
//!   "output_style" : Tools.Sass.STYLE_COMPRESSED
//!   "source_map_file" : "path/to/write/source.map"
//! ]));
//!
//! if (mixed e = catch(compiler->compile_file("input.scss", "output.css"))) {
//!   werror("Failed compiling input.scss to output.css\n");
//! }
//! @endcode
class SCSS
{
  inherit Tools@module@.Api;

  //! Compile the file @[input_file] and return the result
  //!
  //! @param input_file
  //!  The SCSS file to compile
  //!
  //! @returns
  //!  A mapping with the generated CSS and source mapping file if such is
  //!  set to be generated
  //!
  //!  @mapping
  //!   @member string "css"
  //!    The generated CSS
  //!   @member string "map"
  //!    The generated source mapping data
  //!  @endmapping
  mapping(string:string) compile_file(string input_file)
  {
    mapping(string:string) val = ::compile_file(input_file);
    return val;
  }

  //! Compile the file @[input_file] and write the result to @[output_file].
  //! If a source mapping file is set to be generated either via
  //! @[set_options()] or @[set_source_map_file()] it will be written as per
  //! the value set in the option.
  //!
  //! @param input_file
  //!  The SCSS file to compile
  //! @param output_file
  //!  The name of the CSS file to save the result in.
  variant void compile_file(string input_file, string output_file)
  {
    mapping(string:string) val = ::compile_file(input_file);
    Stdio.write_file(output_file, val->css);

    if (val->map) {
      string smap_path = ::get_source_map_file();
      Stdio.write_file(smap_path, val->map);
    }
  }


  //! Compile the string @[source]
  //!
  //! @param source
  //!  The string to compile
  string(8bit) compile_string(string(8bit) source)
  {
    string(8bit) out = ::compile_string(source);
    return out;
  }

  //! Set options to the SASS compiler. @[opts]
  //!
  //! @param opts
  //!  @mapping
  //!   @member int "output_style"
  //!    Any of the @[STYLE_NESTED], @[STYLE_EXPANDED], @[STYLE_COMPACT]
  //!    or @[STYLE_COMPRESSED] constants. See also @[set_output_style()].
  //!
  //!   @member string "include_path"
  //!    Path to root of incude files. See also @[set_include_path()].
  //!
  //!   @member string "source_map_file"
  //!    File to write source map file to. Only has effect in @[compile_file()].
  //!    See also @[set_source_map_file()].
  //!
  //!   @member bool "source_comments"
  //!    Turn on/off comments in the output containing info about the source
  //!    file - line numbers and such. Default of @tt{false@}. See also
  //!    @[set_source_comments()].
  //!
  //!   @member bool "source_map_embed"
  //!    Turn on/off if a source map should be embedded in the output or not.
  //!    Default is @tt{false@}. See also @[set_source_map_embed()].
  //!
  //!   @member string "source_map_root"
  //!    Set the root path of the source files, relative to where the
  //!    source.map file is written.
  //!    See also @[set_source_map_root()]
  //!
  //!   @member bool "omit_source_map"
  //!    Omit the #sourceMappingURL or not.
  //!    See also @[set_omit_source_map_url()]
  //!  @endmapping
  void set_options(mapping(string:string|int) opts)
  {
    foreach (opts; string opt; string|int val) {
      switch (opt)
      {
        case "output_style":
          if (!intp(val)) {
            error("Value to set_output_style() must be an integer!\n");
          }
          set_output_style(val);
          break;

        case "include_path":
          if (!stringp(val)) {
            error("Value to set_include_path() must be a string!\n");
          }
          set_include_path(val);
          break;

        case "source_map_file":
          if (!stringp(val)) {
            error("Value to set_source_map_file() must be a string!\n");
          }
          set_source_map_file(val);
          break;

        case "source_map_embed":
          if (!intp(val)) {
            error("Value to set_source_map_embed() must be an int(0..1)!\n");
          }
          set_source_map_embed(val);
          break;

        case "source_map_root":
          if (!stringp(val)) {
            error("Value to set_source_map_root() must be a string!\n");
          }
          set_source_map_root(val);
          break;

        case "omit_source_map":
          if (!intp(val)) {
            error("Value to set_omit_source_map_url() must be an integer!\n");
          }
          set_omit_source_map_url(val);
          break;

        case "source_comments":
          if (!intp(val)) {
            error("Value to set_source_comments() must be an integer!\n");
          }
          set_source_comments(val);
          break;

        default:
          error("Unknown option %O!\n", opt);
      }
    }
  }
}
